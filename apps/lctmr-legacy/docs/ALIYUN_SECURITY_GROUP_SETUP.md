# 阿里云安全组配置指南

## 📋 概述

如果您需要通过公网 IP 访问开发环境，需要在阿里云控制台的安全组中开放相应端口。

## 🔐 当前环境端口配置

| 环境 | 端口 | 用途 | 是否需要开放 |
|------|------|------|------------|
| **生产环境** | **3001** | 生产服务 | 通常通过 Nginx 反向代理（端口 80/443）访问 |
| **开发环境** | **3002** | 开发测试 | 需要开放才能从外网访问 |

## 📝 阿里云安全组配置步骤

### 方法一：通过阿里云控制台配置

1. **登录阿里云控制台**
   - 访问：https://ecs.console.aliyun.com
   - 登录您的账号

2. **进入安全组管理**
   - 左侧菜单：**网络与安全** → **安全组**
   - 找到您的 ECS 实例所属的安全组

3. **添加入站规则**
   - 点击安全组ID进入详情
   - 点击 **入方向** → **手动添加**
   - 添加以下规则：

   ```
   规则方向: 入方向
   授权策略: 允许
   协议类型: 自定义 TCP
   端口范围: 3002/3002
   授权对象: 0.0.0.0/0（或指定您的IP地址）
   描述: 开发环境端口
   ```

4. **保存规则**
   - 点击 **保存** 完成配置

### 方法二：通过阿里云 CLI（如果已安装）

```bash
# 添加安全组规则（需要先安装阿里云 CLI）
aliyun ecs AuthorizeSecurityGroup \
  --RegionId cn-hangzhou \
  --SecurityGroupId sg-xxxxx \
  --IpProtocol tcp \
  --PortRange 3002/3002 \
  --SourceCidrIp 0.0.0.0/0
```

## 🛡️ 安全建议

### 推荐配置（更安全）

**选项 1：仅允许特定 IP 访问开发环境**
```
端口范围: 3002/3002
授权对象: 您的办公IP地址/32
描述: 开发环境（仅限办公室）
```

**选项 2：仅允许内网访问**
```
端口范围: 3002/3002
授权对象: 172.19.0.0/16（您的内网段）
描述: 开发环境（仅内网）
```

### 不推荐配置

❌ **开放给所有人** (`0.0.0.0/0`)
   - 安全性较低
   - 建议仅用于临时测试

## 📊 端口访问测试

### 配置完成后测试

```bash
# 从外部测试开发环境
curl http://120.79.181.206:3002/health

# 应该返回：
# {"status":"ok","timestamp":"...","uptime":...}
```

### 检查端口是否开放

```bash
# 使用 telnet 测试（需要安装 telnet）
telnet 120.79.181.206 3002

# 或使用 nc (netcat)
nc -zv 120.79.181.206 3002
```

## 🔍 故障排查

### 问题 1：配置后仍无法访问

**检查清单：**
1. ✅ 安全组规则是否保存成功
2. ✅ ECS 实例是否绑定了正确的安全组
3. ✅ 服务器本地防火墙是否开放（如 iptables、ufw）
4. ✅ 开发环境服务是否正常运行

**检查本地防火墙：**
```bash
# 检查 ufw 状态
sudo ufw status

# 如果使用 ufw，开放端口
sudo ufw allow 3002/tcp

# 检查 iptables
sudo iptables -L -n | grep 3002
```

### 问题 2：只想内网访问

**解决方案：**
1. 安全组授权对象设置为内网IP段
2. 或使用 SSH 隧道进行端口转发：

```bash
# 通过 SSH 隧道访问开发环境
ssh -L 3002:localhost:3002 user@120.79.181.206

# 然后访问本地：http://localhost:3002
```

## 📋 生产环境建议

### 生产环境（端口 3001）

**通常不需要开放端口 3001，因为：**

1. **通过 Nginx 反向代理**
   - 生产环境通常通过 Nginx 在端口 80/443 提供服务
   - 用户访问域名，Nginx 转发到 3001 端口
   - 只需要开放 80/443 端口

2. **仅内网访问**
   - 3001 端口仅在内网监听
   - 不需要在安全组中开放

### Nginx 配置示例（如果使用）

```nginx
# 生产环境反向代理
server {
    listen 80;
    server_name process.xjio.cn;
    
    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 开发环境反向代理（可选）
server {
    listen 8080;
    server_name dev.example.com;
    
    location / {
        proxy_pass http://localhost:3002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 🎯 快速配置清单

- [ ] 登录阿里云控制台
- [ ] 找到 ECS 实例的安全组
- [ ] 添加入站规则：端口 3002，TCP 协议
- [ ] 设置授权对象（建议仅您的IP或内网段）
- [ ] 保存规则
- [ ] 测试访问：`curl http://120.79.181.206:3002/health`
- [ ] 验证前端访问是否正常

---

**最后更新**: 2025-11-03


