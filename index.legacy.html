<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线文档系统</title>
    <!-- 引入 Tailwind CSS 以便快速构建现代化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 简单的页面过渡效果 */
        .page {
            display: none; /* 默认所有页面都隐藏 */
        }
        .page.active {
            display: block; /* 激活的页面显示 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- 1. 加载中页面 -->
    <div id="loading-screen" class="page active text-center p-8">
        <div class="text-2xl font-semibold">系统加载中...</div>
        <div class="mt-4 text-gray-600">正在连接服务，请稍候。</div>
    </div>

    <!-- 2. 登录页面 -->
    <div id="login-page" class="page w-full max-w-md p-8 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center text-gray-800">欢迎登录</h2>
        <p class="text-center text-gray-500 mt-2">请输入您的凭据</p>
        <div class="mt-6 space-y-5">
            <!-- 登录表单 (模拟) -->
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700">邮箱</label>
                <input type="email" id="username" value="" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="name@example.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="至少 6 位字符">
            </div>
            <div class="flex flex-col gap-3">
                <button id="login-button" data-default-label="登录" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                    登录
                </button>
                <button id="register-button" data-default-label="注册" class="w-full bg-white border border-blue-200 text-blue-700 py-2 px-4 rounded-md font-semibold hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                    注册新账号
                </button>
            </div>
            <p class="text-xs text-gray-500">没有账号可通过注册创建；如仅体验功能，可留空直接匿名登录。</p>
            <div id="auth-message" class="hidden text-sm mt-2 px-3 py-2 rounded-md"></div>
        </div>
    </div>

    <!-- 3. 应用主容器 (登录后显示) -->
    <div id="app-container" class="page w-full max-w-4xl p-8 bg-white rounded-lg shadow-md">
        
        <!-- 3a. 仪表盘页面 -->
        <div id="dashboard-page" class="page active">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">我的仪表盘</h1>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-gray-800">退出登录</button>
            </div>
            <p class="mb-6 text-gray-600">欢迎回来！您的用户ID: <code id="user-id-display" class="text-sm bg-gray-100 p-1 rounded">...</code></p>
            
            <button id="show-editor-button" class="w-full md:w-auto bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 shadow-md">
                + 创建新文档
            </button>

            <!-- 搜索框 (MVP 新增) -->
            <div class="mt-8 mb-4">
                <label for="search-bar" class="block text-sm font-medium text-gray-700">搜索我的文档</label>
                <input type="text" id="search-bar" placeholder="按标题搜索..." class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- 文档列表 -->
            <div id="documents-list" class="mt-4 space-y-4">
                <!-- 列表将在这里动态生成 -->
            </div>
        </div>

        <!-- 3b. 文档编辑器页面 -->
        <div id="editor-page" class="page">
            <div class="flex justify-between items-center mb-6">
                <h1 id="editor-title" class="text-3xl font-bold text-gray-900">创建新文档</h1>
                <div class="flex items-center gap-4">
                    <span id="save-status" class="text-sm text-gray-500 hidden">
                        <span id="save-status-text">未保存</span>
                    </span>
                    <span id="word-count" class="text-sm text-gray-500">0 字</span>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="doc-title" class="block text-sm font-medium text-gray-700 mb-1">文档标题</label>
                <input type="text" id="doc-title" class="block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="给你的文档起个名字">
            </div>

            <div class="mb-6">
                <label for="doc-content" class="block text-sm font-medium text-gray-700 mb-1">文档内容</label>
                <textarea id="doc-content" rows="20" class="block w-full px-4 py-3 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 resize-y font-mono text-sm leading-relaxed" placeholder="在这里填写文档内容...&#10;&#10;提示：按 Ctrl+S (Windows) 或 Cmd+S (Mac) 快速保存"></textarea>
            </div>

            <div id="save-message" class="mb-4 hidden px-4 py-2 rounded-md"></div>

            <div class="flex flex-col md:flex-row gap-4">
                <button id="save-button" data-create-label="保存文档" data-update-label="更新文档" class="w-full md:w-auto bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                    保存文档
                </button>
                <button id="back-to-dashboard-button" class="w-full md:w-auto bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                    返回仪表盘
                </button>
                <!-- (版本控制 新增) 历史版本按钮，暂时禁用 -->
                <button id="history-button" class="w-full md:w-auto bg-gray-400 text-white py-2 px-6 rounded-lg font-semibold focus:outline-none transition duration-200 cursor-not-allowed" disabled title="即将推出">
                    查看历史版本
                </button>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 (MVP 新增) -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900">确认删除</h3>
            <p class="my-4 text-gray-600">您确定要删除这个文档吗？此操作无法撤销。</p>
            <div class="flex justify-end gap-4 mt-6">
                <button id="cancel-delete-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">
                    取消
                </button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <!-- (版本控制 新增) 历史版本模态框 -->
    <div id="history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 class="text-lg font-bold text-gray-900">文档历史版本</h3>
            <div id="history-list-container" class="my-4 text-gray-600 max-h-96 overflow-y-auto">
                <!-- 历史版本将在这里加载 -->
                <p>正在加载历史记录...</p>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="close-history-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyCfaXqI5VsPzNME_-mIpFp_1Yq6Ij9b9Xg",
            authDomain: "ssss-9348e.firebaseapp.com",
            projectId: "ssss-9348e",
            storageBucket: "ssss-9348e.firebasestorage.app",
            messagingSenderId: "354969438898",
            appId: "1:354969438898:web:3fe49633eb0cedafabd7ab",
            measurementId: "G-5CSTQVDTJ7"
        });
    </script>
    <!-- Firebase 核心 JS SDK -->
    <script type="module">
        // 导入 Firebase 模块
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            collection, 
            query, 
            onSnapshot,
            Timestamp,
            setLogLevel,
            updateDoc, 
            deleteDoc,
            getDoc,
            getDocs  // (版本控制 新增) 用于获取历史版本列表
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全局变量 ---
        let auth;
        let db;
        let userId;
        let userDocsCollectionRef; // 用户文档集合的引用
        let currentEditingDocId = null; // (MVP 新增) 跟踪当前编辑的文档ID
        let allUserDocs = []; // (MVP 新增) 缓存所有文档用于搜索
        let docIdToDelete = null; // (MVP 新增) 跟踪待删除的文档ID
        let lastSavedContent = ''; // (编辑器优化) 跟踪上次保存的内容
        let lastSavedTitle = ''; // (编辑器优化) 跟踪上次保存的标题
        let autoSaveTimer = null; // (编辑器优化) 自动保存定时器
        let currentDocVersions = []; // (版本控制) 当前文档的历史版本缓存
        const AUTO_SAVE_DELAY = 5000; // 自动保存延迟（毫秒）
        const LOGIN_BUTTON_DEFAULT_TEXT = document.getElementById('login-button')?.dataset?.defaultLabel || '登录';
        const REGISTER_BUTTON_DEFAULT_TEXT = document.getElementById('register-button')?.dataset?.defaultLabel || '注册';
        const emailInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authMessageEl = document.getElementById('auth-message');

        // --- 工具函数 ---
        function getDocTimestamp(docData) {
            const timestamp = docData?.updatedAt || docData?.createdAt;
            return timestamp && typeof timestamp.toMillis === 'function' ? timestamp : null;
        }

        function getDocTimeMeta(docData) {
            const timestamp = getDocTimestamp(docData);
            const hasUpdated = !!docData?.updatedAt;
            if (!timestamp) {
                return { label: '时间未知', value: '--' };
            }
            return {
                label: hasUpdated ? '更新于:' : '创建于:',
                value: timestamp.toDate().toLocaleString('zh-CN')
            };
        }

        function setSaveButtonLabel(isEditing) {
            const saveButton = document.getElementById('save-button');
            if (!saveButton) return;
            const label = isEditing 
                ? (saveButton.dataset.updateLabel || '更新文档') 
                : (saveButton.dataset.createLabel || '保存文档');
            saveButton.textContent = label;
        }

        function getCredentialInputs() {
            return {
                email: emailInput?.value.trim() || '',
                password: passwordInput?.value.trim() || ''
            };
        }

        function showAuthMessage(type, text) {
            if (!authMessageEl) return;
            authMessageEl.textContent = text;
            authMessageEl.classList.remove('hidden', 'text-green-600', 'bg-green-50', 'text-red-600', 'bg-red-50');
            if (type === 'success') {
                authMessageEl.classList.add('text-green-600', 'bg-green-50');
            } else {
                authMessageEl.classList.add('text-red-600', 'bg-red-50');
            }
        }

        function clearAuthMessage() {
            if (!authMessageEl) return;
            authMessageEl.classList.add('hidden');
            authMessageEl.textContent = '';
        }

        function translateAuthError(error) {
            if (!error?.code) return error?.message || '发生未知错误';
            const map = {
                'auth/email-already-in-use': '该邮箱已注册，请直接登录。',
                'auth/invalid-email': '邮箱格式不正确。',
                'auth/missing-email': '请输入邮箱。',
                'auth/missing-password': '请输入密码。',
                'auth/weak-password': '密码至少 6 位。',
                'auth/user-not-found': '未找到该用户，请检查邮箱或先注册。',
                'auth/wrong-password': '密码错误，请重试。'
            };
            return map[error.code] || error.message;
        }

        // --- 编辑器工具函数 ---
        function updateWordCount() {
            const content = document.getElementById('doc-content')?.value || '';
            const wordCount = content.length;
            const wordCountEl = document.getElementById('word-count');
            if (wordCountEl) {
                wordCountEl.textContent = `${wordCount} 字`;
            }
        }

        function updateSaveStatus(isSaved = false, message = '') {
            const saveStatusEl = document.getElementById('save-status');
            const saveStatusTextEl = document.getElementById('save-status-text');
            if (!saveStatusEl || !saveStatusTextEl) return;
            
            if (isSaved) {
                saveStatusEl.classList.remove('hidden');
                saveStatusTextEl.textContent = message || '已保存';
                saveStatusEl.classList.remove('text-gray-500');
                saveStatusEl.classList.add('text-green-600');
            } else {
                saveStatusEl.classList.remove('hidden');
                saveStatusTextEl.textContent = message || '未保存';
                saveStatusEl.classList.remove('text-green-600');
                saveStatusEl.classList.add('text-gray-500');
            }
        }

        function hasUnsavedChanges() {
            const title = document.getElementById('doc-title')?.value.trim() || '';
            const content = document.getElementById('doc-content')?.value.trim() || '';
            return title !== lastSavedTitle || content !== lastSavedContent;
        }

        function checkAndUpdateSaveStatus() {
            if (hasUnsavedChanges()) {
                updateSaveStatus(false, '未保存');
            } else if (lastSavedTitle || lastSavedContent) {
                updateSaveStatus(true, '已保存');
            } else {
                updateSaveStatus(false, '未保存');
            }
        }

        function showSaveMessage(type, text) {
            const saveMessageEl = document.getElementById('save-message');
            if (!saveMessageEl) return;
            saveMessageEl.textContent = text;
            saveMessageEl.classList.remove('hidden', 'text-green-600', 'bg-green-50', 'text-red-600', 'bg-red-50');
            if (type === 'success') {
                saveMessageEl.classList.add('text-green-600', 'bg-green-50');
            } else {
                saveMessageEl.classList.add('text-red-600', 'bg-red-50');
            }
        }

        function scheduleAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            if (!hasUnsavedChanges()) {
                return;
            }
            autoSaveTimer = setTimeout(() => {
                const editorPage = document.getElementById('editor-page');
                if (editorPage && editorPage.classList.contains('active')) {
                    saveDocument({ silent: true });
                }
            }, AUTO_SAVE_DELAY);
        }

        function resetEditorState() {
            lastSavedTitle = '';
            lastSavedContent = '';
            currentDocVersions = [];
            stopAutoSave();
            updateWordCount();
            updateSaveStatus(false, '未保存');
            document.getElementById('save-message')?.classList.add('hidden');
        }

        function stopAutoSave() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
        }

        // --- Firebase 配置 ---
        // Canvas 坏境会注入这些变量
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" }; // 备用配置

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 设置日志级别
        setLogLevel('Debug');

        // --- 页面导航函数 ---

        // (MVP 修复) 导航函数 (内部应用页面)
        function showAppPage(pageId) {
            // 隐藏 #app-container 内部的所有 .page 元素
            document.querySelectorAll('#app-container .page').forEach(page => {
                page.classList.remove('active');
            });
            // 仅显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        function showPage(pageId) {
            // 隐藏所有 .page 元素
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 仅显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // 特殊逻辑：如果显示 app-container，则默认显示其内部的 dashboard
            if (pageId === 'app-container') {
                showAppPage('dashboard-page'); // (MVP 修复) 确保 showAppPage 已定义
            }
        }

        // (MVP 新增) 渲染文档列表
        function renderDocumentList(docsToRender) {
            const listContainer = document.getElementById('documents-list');
            
            if (docsToRender.length === 0) {
                const searchTerm = document.getElementById('search-bar').value;
                listContainer.innerHTML = searchTerm
                    ? '<p class="text-gray-500">未找到匹配的文档。</p>'
                    : '<p class="text-gray-500">还没有文档，点击“+ 创建新文档”开始吧。</p>';
                return;
            }

            listContainer.innerHTML = ''; // 清空列表

            docsToRender.forEach(docData => {
                const docEl = document.createElement('div');
                docEl.className = 'p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm';
                
                const title = docData.title || '无标题文档';
                const contentPreview = (docData.content || '').substring(0, 50) + '...';
                
                const { label: timeLabel, value: time } = getDocTimeMeta(docData);

                docEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg text-blue-700">${title}</h3>
                            <p class="text-sm text-gray-600 mt-1">${contentPreview}</p>
                            <p class="text-xs text-gray-400 mt-2">${timeLabel} ${time}</p>
                        </div>
                        <div class="flex-shrink-0 flex gap-4 mt-1">
                            <button class="edit-btn text-sm font-medium text-blue-600 hover:underline" data-id="${docData.id}">
                                编辑
                            </button>
                            <button class="delete-btn text-sm font-medium text-red-600 hover:underline" data-id="${docData.id}">
                                删除
                            </button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(docEl);
            });
        }

        // (MVP 新增) 过滤并渲染文档
        function filterAndRenderDocuments() {
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            if (!searchTerm) {
                renderDocumentList(allUserDocs); // 渲染全部
                return;
            }
            const filteredDocs = allUserDocs.filter(doc => 
                doc.title && doc.title.toLowerCase().includes(searchTerm)
            );
            renderDocumentList(filteredDocs);
        }

        // 7. 实时监听文档列表 (函数定义) - (MVP 修改)
        function setupDocumentListener() {
            if (!userDocsCollectionRef) return;

            // onSnapshot 会在数据首次加载和后续变更时触发
            onSnapshot(userDocsCollectionRef, (snapshot) => {
                
                let docs = [];
                snapshot.forEach((doc) => {
                    docs.push({ id: doc.id, ...doc.data() });
                });

                // 按时间降序排序 (优先 updatedAt)
                docs.sort((a, b) => {
                    const timeA = getDocTimestamp(a);
                    const timeB = getDocTimestamp(b);
                    const millisA = timeA ? timeA.toMillis() : 0;
                    const millisB = timeB ? timeB.toMillis() : 0;
                    return millisB - millisA;
                });
                
                allUserDocs = docs; // 缓存所有文档
                filterAndRenderDocuments(); // 根据当前搜索词渲染

            }, (error) => {
                console.error("监听文档失败:", error);
                document.getElementById('documents-list').innerHTML = '<p class="text-red-500">加载文档列表失败。</p>';
            });
        }

        // --- 核心业务逻辑 ---

        // 1. 初始化 Firebase
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase 初始化成功。");

            // 2. 监听认证状态
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // 用户已登录
                    console.log("用户已认证:", user.uid);
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;

                    // 设置数据库集合引用
                    const collectionPath = `/artifacts/${appId}/users/${userId}/documents`;
                    console.log("数据库路径:", collectionPath);
                    userDocsCollectionRef = collection(db, collectionPath);

                    // 启动文档监听
                    setupDocumentListener(); // (MVP 修改)

                    // 显示应用主界面
                    showPage('app-container');
                    showAppPage('dashboard-page');

                } else {
                    // 用户未登录
                    console.log("用户未认证。");
                    userId = null;
                    userDocsCollectionRef = null;
                    // 显示登录页面
                    showPage('login-page');
                }
            });

            // 3. 登录逻辑
            const loginButton = document.getElementById('login-button');
            loginButton.addEventListener('click', async () => {
                if (loginButton.disabled) return;
                clearAuthMessage();
                const { email, password } = getCredentialInputs();
                const hasCredentials = !!(email && password);
                loginButton.disabled = true;
                loginButton.textContent = "登录中...";
                try {
                    if (hasCredentials) {
                        await signInWithEmailAndPassword(auth, email, password);
                        showAuthMessage('success', '登录成功，正在跳转...');
                    } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("使用 custom token 登录...");
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        console.log("使用匿名方式登录...");
                        await signInAnonymously(auth);
                    }
                    // onAuthStateChanged 会自动处理后续跳转
                } catch (error) {
                    console.error("登录失败:", error);
                    showAuthMessage('error', translateAuthError(error));
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = LOGIN_BUTTON_DEFAULT_TEXT;
                }
            });

            // 4. 退出登录
            document.getElementById('logout-button').addEventListener('click', async () => {
                await signOut(auth);
                // onAuthStateChanged 会自动处理页面跳转
            });

            const registerButton = document.getElementById('register-button');
            registerButton.addEventListener('click', async () => {
                if (registerButton.disabled) return;
                const { email, password } = getCredentialInputs();
                if (!email || !password) {
                    showAuthMessage('error', '请输入邮箱和密码后再注册。');
                    return;
                }
                registerButton.disabled = true;
                registerButton.textContent = "注册中...";
                clearAuthMessage();
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showAuthMessage('success', '注册成功，已自动登录。');
                } catch (error) {
                    console.error("注册失败:", error);
                    showAuthMessage('error', translateAuthError(error));
                } finally {
                    registerButton.disabled = false;
                    registerButton.textContent = REGISTER_BUTTON_DEFAULT_TEXT;
                }
            });

            // 5. 页面切换按钮
            document.getElementById('show-editor-button').addEventListener('click', () => {
                // (MVP 新增) 重置为"创建"状态
                currentEditingDocId = null;
                document.getElementById('editor-title').textContent = "创建新文档";
                setSaveButtonLabel(false);

                // (版本控制 新增) 禁用历史按钮
                document.getElementById('history-button').disabled = true;
                document.getElementById('history-button').classList.add('cursor-not-allowed', 'bg-gray-400');
                document.getElementById('history-button').classList.remove('bg-teal-600', 'hover:bg-teal-700');

                // 清空编辑器内容
                document.getElementById('doc-title').value = '';
                document.getElementById('doc-content').value = '';
                resetEditorState();
                
                // 切换到编辑器
                showAppPage('editor-page');
            });

            document.getElementById('back-to-dashboard-button').addEventListener('click', () => {
                stopAutoSave();
                showAppPage('dashboard-page');
            });

            // 6. 保存/更新文档逻辑 (版本控制 重构 + 编辑器优化)
            async function saveDocument(options = {}) {
                const silent = !!options.silent;
                const title = document.getElementById('doc-title').value.trim();
                const content = document.getElementById('doc-content').value.trim();
                const saveButton = document.getElementById('save-button');

                if (!title || !content) {
                    if (!silent) {
                        showSaveMessage('error', "标题和内容均不能为空。");
                    }
                    return;
                }

                if (!auth.currentUser || !userDocsCollectionRef) {
                    if (!silent) {
                        showSaveMessage('error', "用户未登录或数据库未准备好，请稍后再试。");
                    }
                    return;
                }

                saveButton.disabled = true;
                const originalText = saveButton.textContent;
                if (!silent) {
                    saveButton.textContent = "保存中...";
                }

                try {
                    const now = Timestamp.now(); // 统一时间戳

                    if (currentEditingDocId) {
                        // --- 更新逻辑 (实现版本控制) ---
                        
                        // 1. 获取主文档引用
                        const docRef = doc(db, userDocsCollectionRef.path, currentEditingDocId);
                        
                        // 2. (新增) 获取当前文档数据，将其存入 'versions' 子集合
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const oldData = docSnap.data();
                            const versionsCollectionRef = collection(db, docRef.path, "versions");
                            // 将 *旧* 数据存为版本
                            await addDoc(versionsCollectionRef, {
                                title: oldData.title,
                                content: oldData.content,
                                savedAt: oldData.updatedAt || oldData.createdAt // 使用上一个保存点的时间
                            });
                        } else {
                            console.warn("未找到原始文档，无法创建历史版本。");
                        }

                        // 3. (现有) 用 *新* 数据更新主文档
                        await updateDoc(docRef, {
                            title: title,
                            content: content,
                            updatedAt: now 
                        });
                        console.log("文档已更新, ID: ", currentEditingDocId);
                        if (!silent) {
                            showSaveMessage('success', "文档更新成功！(已保存历史版本)");
                        }
                        lastSavedTitle = title;
                        lastSavedContent = content;
                        updateSaveStatus(true, silent ? '已自动保存' : '已保存');

                    } else {
                        // --- 创建逻辑 (实现版本控制) ---

                        // 1. (现有) 创建主文档
                        const newDoc = {
                            title: title,
                            content: content,
                            createdAt: now 
                        };
                        const newDocRef = await addDoc(userDocsCollectionRef, newDoc);

                        // 2. (新增) 同时在 'versions' 子集合中创建 v1
                        const versionsCollectionRef = collection(db, newDocRef.path, "versions");
                        await addDoc(versionsCollectionRef, {
                            title: title,
                            content: content,
                            savedAt: now // 使用创建时间
                        });
                        
                        console.log("文档已保存, ID: ", newDocRef.id);
                        if (!silent) {
                            showSaveMessage('success', "文档保存成功！(已创建 v1)");
                        }
                        lastSavedTitle = title;
                        lastSavedContent = content;
                        currentEditingDocId = newDocRef.id; // 设置为编辑状态
                        setSaveButtonLabel(true);
                        updateSaveStatus(true, silent ? '已自动保存' : '已保存');
                    }
                    stopAutoSave();

                } catch (error) {
                    console.error("保存/更新文档失败:", error);
                    if (!silent) {
                        showSaveMessage('error', "操作失败: " + error.message);
                    } else {
                        updateSaveStatus(false, '自动保存失败');
                    }
                } finally {
                    saveButton.disabled = false;
                    if (!silent) {
                        saveButton.textContent = originalText;
                    }
                }
            }

            document.getElementById('save-button').addEventListener('click', saveDocument);

            // (编辑器优化) 键盘快捷键支持
            document.addEventListener('keydown', (e) => {
                // Ctrl+S 或 Cmd+S 保存
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    const editorPage = document.getElementById('editor-page');
                    if (editorPage && editorPage.classList.contains('active')) {
                        saveDocument();
                    }
                }
            });

            // (编辑器优化) 实时更新字数统计和保存状态
            const docTitleInput = document.getElementById('doc-title');
            const docContentInput = document.getElementById('doc-content');
            
            if (docTitleInput) {
                docTitleInput.addEventListener('input', () => {
                    checkAndUpdateSaveStatus();
                    scheduleAutoSave();
                });
            }
            
            if (docContentInput) {
                docContentInput.addEventListener('input', () => {
                    updateWordCount();
                    checkAndUpdateSaveStatus();
                    scheduleAutoSave();
                });
                // 初始化字数和状态
                updateWordCount();
                updateSaveStatus(false, '未保存');
            }

            // (MVP 新增) 搜索框事件
            document.getElementById('search-bar').addEventListener('input', filterAndRenderDocuments);

            // (MVP 新增) 文档列表事件委托 (编辑/删除)
            document.getElementById('documents-list').addEventListener('click', (e) => {
                const target = e.target;
                const docId = target.dataset.id;
                
                if (target.classList.contains('edit-btn') && docId) {
                    // --- 编辑按钮点击 ---
                    const docToEdit = allUserDocs.find(doc => doc.id === docId);
                    if (!docToEdit) {
                        console.error("未在缓存中找到文档: ", docId);
                        return;
                    }

                    // 设置为"编辑"状态
                    currentEditingDocId = docId;
                    const title = docToEdit.title || '';
                    const content = docToEdit.content || '';
                    document.getElementById('doc-title').value = title;
                    document.getElementById('doc-content').value = content;
                    document.getElementById('editor-title').textContent = "编辑文档";
                    setSaveButtonLabel(true);
                    document.getElementById('save-message').classList.add('hidden');

                    // (编辑器优化) 记录当前保存的内容
                    lastSavedTitle = title;
                    lastSavedContent = content;
                    updateWordCount();
                    updateSaveStatus(true, '已保存');

                    // (版本控制 新增) 启用历史按钮
                    const historyButton = document.getElementById('history-button');
                    historyButton.disabled = false;
                    historyButton.classList.remove('cursor-not-allowed', 'bg-gray-400');
                    historyButton.classList.add('bg-teal-600', 'hover:bg-teal-700', 'text-white');

                    showAppPage('editor-page');

                } else if (target.classList.contains('delete-btn') && docId) {
                    // --- 删除按钮点击 ---
                    docIdToDelete = docId;
                    document.getElementById('delete-modal').classList.remove('hidden');
                }
            });

            // (版本控制 新增) 历史模态框事件
            document.getElementById('history-button').addEventListener('click', async () => {
                if (!currentEditingDocId || !userDocsCollectionRef) return;
                const historyContainer = document.getElementById('history-list-container');
                historyContainer.innerHTML = '<p class="text-gray-500">正在加载历史记录...</p>';
                document.getElementById('history-modal').classList.remove('hidden');

                try {
                    const docRef = doc(db, userDocsCollectionRef.path, currentEditingDocId);
                    const versionsCollectionRef = collection(db, docRef.path, "versions");
                    const versionsSnapshot = await getDocs(versionsCollectionRef);
                    currentDocVersions = [];
                    versionsSnapshot.forEach((versionDoc) => {
                        currentDocVersions.push({ id: versionDoc.id, ...versionDoc.data() });
                    });

                    if (currentDocVersions.length === 0) {
                        historyContainer.innerHTML = '<p class="text-gray-500">暂无历史版本记录。</p>';
                        return;
                    }

                    currentDocVersions.sort((a, b) => {
                        const timeA = a.savedAt?.toMillis ? a.savedAt.toMillis() : 0;
                        const timeB = b.savedAt?.toMillis ? b.savedAt.toMillis() : 0;
                        return timeB - timeA;
                    });

                    historyContainer.innerHTML = currentDocVersions.map((version, index) => {
                        const time = version.savedAt?.toDate ? version.savedAt.toDate().toLocaleString('zh-CN') : '未知时间';
                        const title = version.title || '无标题';
                        const contentPreview = (version.content || '').substring(0, 120);
                        return `
                            <div class="border border-gray-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">版本 ${currentDocVersions.length - index}</h4>
                                        <p class="text-xs text-gray-500">保存时间: ${time}</p>
                                    </div>
                                    <button data-version-index="${index}" class="restore-version-btn text-sm text-blue-600 hover:text-blue-800">恢复</button>
                                </div>
                                <div class="text-sm text-gray-700">
                                    <p class="font-medium mb-1">${title}</p>
                                    <p class="text-gray-600 whitespace-pre-wrap">${contentPreview}${contentPreview.length >= 120 ? '...' : ''}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error("加载历史版本失败:", error);
                    historyContainer.innerHTML = '<p class="text-red-500">加载历史版本失败: ' + error.message + '</p>';
                }
            });

            document.getElementById('history-list-container').addEventListener('click', (event) => {
                const target = event.target;
                if (!target.classList.contains('restore-version-btn')) return;
                const index = parseInt(target.dataset.versionIndex, 10);
                const version = currentDocVersions[index];
                if (!version) return;

                document.getElementById('doc-title').value = version.title || '';
                document.getElementById('doc-content').value = version.content || '';
                document.getElementById('history-modal').classList.add('hidden');
                updateWordCount();
                updateSaveStatus(false, '已恢复待保存');
                showSaveMessage('success', '已恢复所选版本，请保存以生效。');
                checkAndUpdateSaveStatus();
                scheduleAutoSave();
            });

            document.getElementById('close-history-btn').addEventListener('click', () => {
                document.getElementById('history-modal').classList.add('hidden');
            });

            // (MVP 新增) 删除确认功能
            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                document.getElementById('delete-modal').classList.add('hidden');
                docIdToDelete = null;
            });

            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (!docIdToDelete || !userDocsCollectionRef) {
                    document.getElementById('delete-modal').classList.add('hidden');
                    return;
                }

                const confirmBtn = document.getElementById('confirm-delete-btn');
                confirmBtn.disabled = true;
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = "删除中...";

                try {
                    const docRef = doc(db, userDocsCollectionRef.path, docIdToDelete);
                    await deleteDoc(docRef);
                    console.log("文档已删除, ID: ", docIdToDelete);
                    document.getElementById('delete-modal').classList.add('hidden');
                    docIdToDelete = null;
                } catch (error) {
                    console.error("删除文档失败:", error);
                    alert("删除失败: " + error.message);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            });


        } catch (e) {
            console.error("Firebase 初始化失败:", e);
            document.getElementById('loading-screen').innerText = "系统初始化失败，请检查配置。";
            // 移除了非法的 'return' 语句
        }
    </script>
</body>
</html>