# WDGL-01 æ¶æ„å›¾ Mermaid æºç 
# ================================
# å¤åˆ¶ä¸‹æ–¹ä»£ç åˆ° https://mermaid.live ç”Ÿæˆå›¾è¡¨


# ========================================
# 1. ç³»ç»Ÿå…¨æ™¯æ¶æ„å›¾
# ========================================

graph TB
    subgraph Client["ğŸ–¥ï¸ å®¢æˆ·ç«¯å±‚"]
        Browser["æµè§ˆå™¨"]
    end

    subgraph Frontend["âš›ï¸ Next.js å‰ç«¯åº”ç”¨"]
        subgraph Pages["ğŸ“„ é¡µé¢è·¯ç”±"]
            Login["/login<br/>ç™»å½•é¡µ"]
            Dashboard["/dashboard<br/>é¦–é¡µ(é—®AI)"]
            Editor["/editor/[id]<br/>æ–‡æ¡£ç¼–è¾‘å™¨"]
            Spreadsheet["/spreadsheet/[id]<br/>è¡¨æ ¼ç¼–è¾‘å™¨"]
            Teams["/teams<br/>å›¢é˜Ÿç®¡ç†"]
            TeamKB["/teams/[teamId]/kb/[kbId]<br/>çŸ¥è¯†åº“"]
        end

        subgraph Components["ğŸ§© æ ¸å¿ƒç»„ä»¶"]
            AppSidebar["AppSidebar<br/>å…¨å±€å¯¼èˆªä¾§è¾¹æ "]
            RichTextEditor["RichTextEditor<br/>å¯Œæ–‡æœ¬ç¼–è¾‘å™¨(TipTap)"]
            SpreadsheetEditor["SpreadsheetEditor<br/>è¡¨æ ¼ç¼–è¾‘å™¨(FortuneSheet)"]
            AIComponents["AIQueryPanel / AISidebar<br/>AIå¯¹è¯ç»„ä»¶"]
            DocHeader["DocHeader<br/>æ–‡æ¡£æ ‡é¢˜æ "]
            FolderTree["FolderTree<br/>ç›®å½•æ ‘"]
        end

        subgraph Hooks["ğŸª ä¸šåŠ¡ Hooks"]
            useAutoSave["useAutoSave"]
            useCollaboration["useCollaboration"]
            useComments["useComments"]
            useVersionHistory["useVersionHistory"]
            useDocumentExport["useDocumentExport"]
        end
    end

    subgraph Services["ğŸ”§ æœåŠ¡å±‚"]
        subgraph AILayer["ğŸ¤– AI æœåŠ¡"]
            AIService["AIService.js"]
            EmbeddingModel["embeddingModel.ts<br/>æœ¬åœ°å‘é‡åŒ–"]
            SemanticCache["semanticCache.ts"]
            KnowledgeGraph["knowledgeGraph.ts"]
        end

        subgraph DataServices["ğŸ’¾ æ•°æ®æœåŠ¡"]
            TeamService["teamService.ts<br/>å›¢é˜Ÿç®¡ç†"]
            KBService["kbService.ts<br/>çŸ¥è¯†åº“ç®¡ç†"]
            SpreadsheetService["spreadsheetService.ts<br/>è¡¨æ ¼ç®¡ç†"]
            CommentService["commentService.ts<br/>è¯„è®ºç®¡ç†"]
            VersionService["versionService.ts<br/>ç‰ˆæœ¬å†å²"]
        end

        subgraph Storage["ğŸ“¦ å­˜å‚¨æŠ½è±¡"]
            StorageContext["StorageContext<br/>ç»Ÿä¸€å­˜å‚¨ä¸Šä¸‹æ–‡"]
            MockStorage["mockStorage.js<br/>å¼€å‘æ¨¡å¼"]
        end
    end

    subgraph API["ğŸ”Œ API è·¯ç”±"]
        ChatAPI["/api/chat<br/>AIå¯¹è¯"]
        CompletionAPI["/api/completion<br/>è‡ªåŠ¨è¡¥å…¨"]
        EmbeddingsAPI["/api/embeddings<br/>å‘é‡åŒ–"]
        SearchAPI["/api/search<br/>è¯­ä¹‰æœç´¢"]
        ModelsAPI["/api/models<br/>æ¨¡å‹åˆ—è¡¨"]
    end

    subgraph Backend["â˜ï¸ Supabase åç«¯"]
        SupaAuth["Auth<br/>ç”¨æˆ·è®¤è¯"]
        SupaDB["PostgreSQL<br/>å…³ç³»æ•°æ®åº“"]
        SupaRLS["RLS<br/>è¡Œçº§å®‰å…¨"]
        SupaVector["pgvector<br/>å‘é‡æœç´¢"]
    end

    subgraph WSServer["ğŸ”„ åä½œæœåŠ¡å™¨"]
        WebSocket["ws-server.js<br/>WebSocketæœåŠ¡"]
        Yjs["Yjs<br/>CRDTåŒæ­¥"]
    end

    subgraph External["ğŸŒ å¤–éƒ¨æœåŠ¡"]
        DeepSeek["DeepSeek API"]
        Google["Google Gemini API"]
    end

    Browser --> Frontend
    Frontend --> API
    Frontend --> Backend
    Frontend --> WSServer
    API --> External
    Services --> Backend
    WSServer --> Yjs


# ========================================
# 2. æ•°æ®åº“ ER å›¾
# ========================================

erDiagram
    profiles ||--o{ documents : "owns"
    profiles ||--o{ folders : "owns"
    profiles ||--o{ spreadsheets : "owns"
    profiles ||--o{ teams : "creates"
    
    teams ||--o{ team_members : "has"
    teams ||--o{ knowledge_bases : "contains"
    
    knowledge_bases ||--o{ kb_folders : "organizes"
    knowledge_bases ||--o{ documents : "stores"
    knowledge_bases ||--o{ spreadsheets : "stores"
    
    folders ||--o{ documents : "contains"
    folders ||--o{ spreadsheets : "contains"
    folders ||--o{ folders : "nests"
    
    documents ||--o{ versions : "has"
    documents ||--o{ comments : "has"
    documents ||--o{ document_embeddings : "vectors"
    
    spreadsheets ||--o{ spreadsheet_embeddings : "vectors"
    
    comments ||--o{ comments : "replies"

    profiles {
        uuid id PK
        text display_name
        text avatar_url
        timestamp created_at
    }

    teams {
        uuid id PK
        text name
        text description
        text visibility
        uuid created_by FK
    }

    team_members {
        uuid team_id PK_FK
        uuid user_id PK_FK
        text role
    }

    knowledge_bases {
        uuid id PK
        text name
        text description
        uuid team_id FK
        uuid created_by FK
    }

    kb_folders {
        uuid id PK
        text name
        uuid knowledge_base_id FK
        uuid parent_id FK
    }

    folders {
        uuid id PK
        text name
        uuid parent_id FK
        uuid user_id FK
    }

    documents {
        uuid id PK
        text title
        text content
        text status
        uuid folder_id FK
        uuid user_id FK
        uuid knowledge_base_id FK
    }

    spreadsheets {
        uuid id PK
        text title
        jsonb data
        uuid folder_id FK
        uuid user_id FK
        uuid knowledge_base_id FK
    }

    versions {
        uuid id PK
        uuid document_id FK
        text title
        text content
        text name
    }

    comments {
        uuid id PK
        uuid document_id FK
        uuid parent_id FK
        text content
        text status
    }

    document_embeddings {
        uuid id PK
        uuid document_id FK
        vector embedding
        text chunk_text
    }

    spreadsheet_embeddings {
        uuid id PK
        uuid spreadsheet_id FK
        vector embedding
        text chunk_text
    }


# ========================================
# 3. å‰ç«¯ç»„ä»¶æ¶æ„å›¾
# ========================================

graph TD
    subgraph Layout["å¸ƒå±€å±‚"]
        RootLayout["RootLayout<br/>æ ¹å¸ƒå±€"]
        AppSidebar["AppSidebar<br/>å…¨å±€ä¾§è¾¹æ "]
        EditorShell["EditorShell<br/>ç¼–è¾‘å™¨å¤–å£³"]
    end

    subgraph PageComponents["é¡µé¢ç»„ä»¶"]
        DashboardPage["Dashboard<br/>é¦–é¡µ/é—®AI"]
        EditorPage["EditorPage<br/>æ–‡æ¡£ç¼–è¾‘"]
        SpreadsheetPage["SpreadsheetPage<br/>è¡¨æ ¼ç¼–è¾‘"]
        TeamsPage["TeamsPage<br/>å›¢é˜Ÿåˆ—è¡¨"]
        KBPage["KBPage<br/>çŸ¥è¯†åº“è¯¦æƒ…"]
    end

    subgraph EditorComponents["ç¼–è¾‘å™¨ç»„ä»¶ç¾¤"]
        DocumentEditorModule["DocumentEditorModule<br/>æ–‡æ¡£ç¼–è¾‘æ¨¡å—"]
        SpreadsheetEditorModule["SpreadsheetEditorModule<br/>è¡¨æ ¼ç¼–è¾‘æ¨¡å—"]

        subgraph DocHeaderGroup["æ–‡æ¡£å¤´éƒ¨"]
            DocHeader["DocHeader"]
            DocToolbar["DocToolbar"]
            MenuBar["MenuBar"]
        end

        subgraph EditorCore["ç¼–è¾‘å™¨æ ¸å¿ƒ"]
            RichTextEditor["RichTextEditor<br/>(TipTap)"]
            SpreadsheetEditor["SpreadsheetEditor<br/>(FortuneSheet)"]
        end

        subgraph EditorPanels["ç¼–è¾‘å™¨é¢æ¿"]
            DocOutline["DocOutline<br/>æ–‡æ¡£å¤§çº²"]
            VersionHistorySidebar["VersionHistorySidebar<br/>ç‰ˆæœ¬å†å²"]
            CommentsSidebar["Comments<br/>è¯„è®ºé¢æ¿"]
            AISidebar["AISidebar<br/>AIåŠ©æ‰‹"]
        end
    end

    subgraph AIComponents["AI ç»„ä»¶"]
        AIQueryPanel["AIQueryPanel<br/>é—®ç­”é¢æ¿"]
        ReferencePanel["ReferencePanel<br/>å¼•ç”¨é¢æ¿"]
        ConversationTabs["ConversationTabs<br/>å¯¹è¯æ ‡ç­¾"]
        KnowledgeBaseSelector["KnowledgeBaseSelector<br/>çŸ¥è¯†åº“é€‰æ‹©å™¨"]
        MagicCommand["MagicCommand<br/>é­”æ³•å‘½ä»¤"]
    end

    subgraph SharedComponents["å…±äº«ç»„ä»¶"]
        FolderTree["FolderTree<br/>ç›®å½•æ ‘"]
        SearchModal["SearchModal<br/>æœç´¢å¼¹çª—"]
        SearchFilterPanel["SearchFilterPanel<br/>é«˜çº§ç­›é€‰"]
        SettingsModal["SettingsModal<br/>è®¾ç½®å¼¹çª—"]
        CreateItemModal["CreateItemModal<br/>æ–°å»ºå¼¹çª—"]
    end

    RootLayout --> AppSidebar
    RootLayout --> PageComponents

    DashboardPage --> AIQueryPanel
    DashboardPage --> ReferencePanel
    DashboardPage --> ConversationTabs

    EditorPage --> DocumentEditorModule
    SpreadsheetPage --> SpreadsheetEditorModule

    DocumentEditorModule --> DocHeaderGroup
    DocumentEditorModule --> RichTextEditor
    DocumentEditorModule --> EditorPanels

    SpreadsheetEditorModule --> DocHeader
    SpreadsheetEditorModule --> SpreadsheetEditor

    AppSidebar --> FolderTree
    AppSidebar --> SharedComponents


# ========================================
# 4. AI æœåŠ¡æ¶æ„å›¾
# ========================================

flowchart TB
    subgraph UserInteraction["ç”¨æˆ·äº¤äº’"]
        ChatInput["ç”¨æˆ·è¾“å…¥"]
        AutoComplete["è‡ªåŠ¨è¡¥å…¨"]
        MagicCmd["é­”æ³•å‘½ä»¤"]
    end

    subgraph FrontendAI["å‰ç«¯ AI ç»„ä»¶"]
        AIQueryPanel["AIQueryPanel"]
        AISidebar["AISidebar"]
        MagicCommand["MagicCommand"]
        GhostText["GhostTextExtension<br/>å¹½çµæ–‡æœ¬"]
    end

    subgraph AIServiceLayer["AI æœåŠ¡å±‚"]
        AIService["AIService.js<br/>ç»Ÿä¸€æœåŠ¡å…¥å£"]
        PromptRegistry["PromptRegistry.js<br/>æç¤ºè¯ç®¡ç†"]
        StreamHandler["StreamHandler.js<br/>æµå¼å¤„ç†"]
    end

    subgraph LocalAI["æœ¬åœ° AI å¤„ç†"]
        EmbeddingModel["embeddingModel.ts<br/>Xenova/all-MiniLM"]
        EmbeddingPool["embeddingPool.ts<br/>åµŒå…¥æ± "]
        SemanticCache["semanticCache.ts<br/>è¯­ä¹‰ç¼“å­˜"]
        KnowledgeGraph["knowledgeGraph.ts<br/>çŸ¥è¯†å›¾è°±"]
        Reranker["reranker.ts<br/>é‡æ’åº"]
        IntentRouter["intentRouter.ts<br/>æ„å›¾è·¯ç”±"]
    end

    subgraph APIRoutes["API è·¯ç”±"]
        ChatAPI["/api/chat"]
        CompletionAPI["/api/completion"]
        EmbeddingsAPI["/api/embeddings"]
        SearchAPI["/api/search"]
    end

    subgraph ExternalLLM["å¤–éƒ¨ LLM"]
        DeepSeek["DeepSeek API<br/>(é»˜è®¤)"]
        Gemini["Google Gemini"]
    end

    subgraph VectorDB["å‘é‡æ•°æ®åº“"]
        PGVector["Supabase pgvector<br/>è¯­ä¹‰æœç´¢"]
    end

    ChatInput --> AIQueryPanel
    AutoComplete --> GhostText
    MagicCmd --> MagicCommand

    FrontendAI --> AIServiceLayer
    AIServiceLayer --> APIRoutes
    APIRoutes --> ExternalLLM
    
    FrontendAI --> LocalAI
    LocalAI --> PGVector
    SearchAPI --> PGVector
    EmbeddingsAPI --> EmbeddingModel


# ========================================
# 5. å®æ—¶åä½œæ—¶åºå›¾
# ========================================

sequenceDiagram
    participant U1 as ç”¨æˆ· A
    participant U2 as ç”¨æˆ· B
    participant FE1 as å‰ç«¯ A
    participant FE2 as å‰ç«¯ B
    participant WS as WebSocket Server
    participant YJS as Yjs CRDT
    participant DB as Supabase

    U1->>FE1: ç¼–è¾‘æ–‡æ¡£
    FE1->>YJS: æœ¬åœ°æ›´æ–° Y.Doc
    YJS->>WS: åŒæ­¥å¢é‡æ•°æ®
    WS->>YJS: å¹¿æ’­åˆ°å…¶ä»–å®¢æˆ·ç«¯
    YJS->>FE2: åˆå¹¶è¿œç¨‹æ›´æ–°
    FE2->>U2: å®æ—¶æ˜¾ç¤ºå˜æ›´

    Note over FE1,FE2: åä½œå…‰æ ‡åŒæ­¥
    FE1->>WS: awareness.setLocalState
    WS->>FE2: å¹¿æ’­å…‰æ ‡ä½ç½®

    Note over FE1,DB: å®šæœŸæŒä¹…åŒ–
    FE1->>DB: è‡ªåŠ¨ä¿å­˜ (5s)
    DB-->>FE1: ç¡®è®¤ä¿å­˜


# ========================================
# 6. ç¼–è¾‘å™¨æ‰©å±•æ€ç»´å¯¼å›¾
# ========================================

mindmap
  root((RichTextEditor))
    TipTap StarterKit
      Paragraph
      Heading
      BulletList
      OrderedList
      Blockquote
      CodeBlock
      HardBreak
    æ ¼å¼æ‰©å±•
      FontFamily
      FontSize
      Color
      Highlight
      TextAlign
      TextStyle
    è¡¨æ ¼æ‰©å±•
      Table
      TableRow
      TableCell
      TableHeader
      TableContextMenu
    åä½œæ‰©å±•
      Collaboration
      CollaborationCursor
      CommentMark
    åª’ä½“æ‰©å±•
      ResizableImage
      Link
      MermaidExtension
      FlowchartExtension
    AIæ‰©å±•
      GhostTextExtension
      SuggestionMark
      MagicCommand
    é«˜çº§æ‰©å±•
      Indent
      TaskList
      TaskItem
      SearchReplaceExtension
      ModuleExtensions


# ========================================
# 7. å®‰å…¨æ¶æ„å›¾
# ========================================

flowchart LR
    subgraph Client["å®¢æˆ·ç«¯è¯·æ±‚"]
        User["ç”¨æˆ·"]
    end

    subgraph Auth["è®¤è¯å±‚"]
        JWT["JWT Token"]
        SupaAuth["Supabase Auth"]
    end

    subgraph RLS["è¡Œçº§å®‰å…¨ç­–ç•¥"]
        PolicyDocs["documents:<br/>auth.uid() = user_id"]
        PolicyFolders["folders:<br/>auth.uid() = user_id"]
        PolicyTeams["teams:<br/>visibility = public<br/>OR membership"]
        PolicyKB["knowledge_bases:<br/>team membership"]
    end

    subgraph Data["æ•°æ®å±‚"]
        DB[(PostgreSQL)]
    end

    User --> JWT
    JWT --> SupaAuth
    SupaAuth --> RLS
    RLS --> DB


# ========================================
# 8. æŠ€æœ¯æ ˆé¥¼å›¾
# ========================================

pie title æŠ€æœ¯æ ˆæ„æˆ
    "Next.js 16 (React 19)" : 35
    "TipTap Editor" : 20
    "Supabase (Auth + DB)" : 25
    "AI æœåŠ¡ (DeepSeek/Gemini)" : 15
    "Yjs åä½œ" : 5
