# WDGL-01 äº§å“æ¶æ„å›¾

> **é¡¹ç›®åç§°**: WDGL-01 ååŒæ–‡æ¡£ç®¡ç†å¹³å°  
> **æŠ€æœ¯æ ˆ**: Next.js + Supabase + TipTap + AI  
> **ç”Ÿæˆæ—¶é—´**: 2025-12-23

---

## ğŸ“Š ç³»ç»Ÿå…¨æ™¯æ¶æ„å›¾

```mermaid
graph TB
    subgraph Client["ğŸ–¥ï¸ å®¢æˆ·ç«¯å±‚"]
        Browser["æµè§ˆå™¨"]
    end

    subgraph Frontend["âš›ï¸ Next.js å‰ç«¯åº”ç”¨"]
        subgraph Pages["ğŸ“„ é¡µé¢è·¯ç”±"]
            Login["/login<br/>ç™»å½•é¡µ"]
            Dashboard["/dashboard<br/>é¦–é¡µ(é—®AI)"]
            Editor["/editor/[id]<br/>æ–‡æ¡£ç¼–è¾‘å™¨"]
            Spreadsheet["/spreadsheet/[id]<br/>è¡¨æ ¼ç¼–è¾‘å™¨"]
            Teams["/teams<br/>å›¢é˜Ÿç®¡ç†"]
            TeamKB["/teams/[teamId]/kb/[kbId]<br/>çŸ¥è¯†åº“"]
        end

        subgraph Components["ğŸ§© æ ¸å¿ƒç»„ä»¶"]
            AppSidebar["AppSidebar Group<br/>(Header/Actions/Nav/User)"]
            RichTextEditor["RichTextEditor<br/>å¯Œæ–‡æœ¬ç¼–è¾‘å™¨(TipTap)"]
            SpreadsheetEditor["SpreadsheetEditor<br/>è¡¨æ ¼ç¼–è¾‘å™¨(FortuneSheet)"]
            AIComponents["AIQueryPanel / AISidebar<br/>AIå¯¹è¯ç»„ä»¶"]
            DocHeader["DocHeader<br/>æ–‡æ¡£æ ‡é¢˜æ "]
            FolderTree["FolderTree<br/>ç›®å½•æ ‘"]
            ErrorBoundary["ErrorBoundary<br/>é”™è¯¯è¾¹ç•Œ"]
        end

        subgraph Hooks["ğŸª ä¸šåŠ¡ Hooks"]
            useAutoSave["useAutoSave"]
            useCollaboration["useCollaboration"]
            useComments["useComments"]
            useVersionHistory["useVersionHistory"]
            useDocumentExport["useDocumentExport"]
        end
    end

    subgraph Services["ğŸ”§ æœåŠ¡å±‚"]
        subgraph AILayer["ğŸ¤– AI æœåŠ¡"]
            AIService["AIService.js"]
            EmbeddingModel["embeddingModel.ts<br/>æœ¬åœ°å‘é‡åŒ–"]
            SemanticCache["semanticCache.ts"]
            KnowledgeGraph["knowledgeGraph.ts"]
        end

        subgraph DataServices["ğŸ’¾ æ•°æ®æœåŠ¡"]
            TeamService["teamService.ts<br/>å›¢é˜Ÿç®¡ç†"]
            KBService["kbService.ts<br/>çŸ¥è¯†åº“ç®¡ç†"]
            SpreadsheetService["spreadsheetService.ts<br/>è¡¨æ ¼ç®¡ç†"]
            CommentService["commentService.ts<br/>è¯„è®ºç®¡ç†"]
            VersionService["versionService.ts<br/>ç‰ˆæœ¬å†å²"]
        end

        subgraph Storage["ğŸ“¦ å­˜å‚¨æŠ½è±¡"]
            StorageContext["StorageContext<br/>ç»Ÿä¸€å­˜å‚¨ä¸Šä¸‹æ–‡"]
        end
    end

    subgraph API["ğŸ”Œ API è·¯ç”±"]
        ChatAPI["/api/chat<br/>AIå¯¹è¯"]
        CompletionAPI["/api/completion<br/>è‡ªåŠ¨è¡¥å…¨"]
        EmbeddingsAPI["/api/embeddings<br/>å‘é‡åŒ–"]
        SearchAPI["/api/search<br/>è¯­ä¹‰æœç´¢"]
        ModelsAPI["/api/models<br/>æ¨¡å‹åˆ—è¡¨"]
    end

    subgraph Backend["â˜ï¸ Supabase åç«¯"]
        SupaAuth["Auth<br/>ç”¨æˆ·è®¤è¯"]
        SupaDB["PostgreSQL<br/>å…³ç³»æ•°æ®åº“"]
        SupaRLS["RLS<br/>è¡Œçº§å®‰å…¨"]
        SupaVector["pgvector<br/>å‘é‡æœç´¢"]
    end

    subgraph WSServer["ğŸ”„ åä½œæœåŠ¡å™¨"]
        WebSocket["ws-server.js<br/>WebSocketæœåŠ¡"]
        Yjs["Yjs<br/>CRDTåŒæ­¥"]
    end

    subgraph External["ğŸŒ å¤–éƒ¨æœåŠ¡"]
        DeepSeek["DeepSeek API"]
        Google["Google Gemini API"]
    end

    Browser --> Frontend
    Frontend --> API
    Frontend --> Backend
    Frontend --> WSServer
    API --> External
    Services --> Backend
    WSServer --> Yjs
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„å›¾

```mermaid
erDiagram
    profiles ||--o{ documents : "owns"
    profiles ||--o{ folders : "owns"
    profiles ||--o{ spreadsheets : "owns"
    profiles ||--o{ teams : "creates"
    
    teams ||--o{ team_members : "has"
    teams ||--o{ knowledge_bases : "contains"
    
    knowledge_bases ||--o{ kb_folders : "organizes"
    knowledge_bases ||--o{ documents : "stores"
    knowledge_bases ||--o{ spreadsheets : "stores"
    
    folders ||--o{ documents : "contains"
    folders ||--o{ spreadsheets : "contains"
    folders ||--o{ folders : "nests"
    
    documents ||--o{ versions : "has"
    documents ||--o{ comments : "has"
    
    comments ||--o{ comments : "replies"

    profiles {
        uuid id PK
        text display_name
        text avatar_url
        timestamp created_at
    }

    teams {
        uuid id PK
        text name
        text description
        text visibility
        uuid created_by FK
    }

    team_members {
        uuid team_id PK,FK
        uuid user_id PK,FK
        text role
    }

    knowledge_bases {
        uuid id PK
        text name
        text description
        uuid team_id FK
        uuid created_by FK
    }

    kb_folders {
        uuid id PK
        text name
        uuid knowledge_base_id FK
        uuid parent_id FK
    }

    folders {
        uuid id PK
        text name
        uuid parent_id FK
        uuid user_id FK
    }

    documents {
        uuid id PK
        text title
        text content
        text status
        uuid folder_id FK
        uuid user_id FK
        uuid knowledge_base_id FK
        uuid team_id FK
        timestamp created_at
        timestamp updated_at
    }

    spreadsheets {
        uuid id PK
        text title
        jsonb data
        uuid folder_id FK
        uuid user_id FK
        uuid knowledge_base_id FK
    }

    versions {
        uuid id PK
        uuid document_id FK
        text title
        text content
        text name
    }

    comments {
        uuid id PK
        uuid document_id FK
        uuid parent_id FK
        text content
        text status
    }
```

---

## ğŸ§© å‰ç«¯ç»„ä»¶æ¶æ„å›¾

```mermaid
graph TD
    subgraph Layout["å¸ƒå±€å±‚"]
        RootLayout["RootLayout<br/>æ ¹å¸ƒå±€"]
        AppSidebar["AppSidebar<br/>å…¨å±€ä¾§è¾¹æ "]
        EditorShell["EditorShell<br/>ç¼–è¾‘å™¨å¤–å£³"]
    end

    subgraph PageComponents["é¡µé¢ç»„ä»¶"]
        DashboardPage["Dashboard<br/>é¦–é¡µ/é—®AI"]
        EditorPage["EditorPage<br/>æ–‡æ¡£ç¼–è¾‘"]
        SpreadsheetPage["SpreadsheetPage<br/>è¡¨æ ¼ç¼–è¾‘"]
        TeamsPage["TeamsPage<br/>å›¢é˜Ÿåˆ—è¡¨"]
        KBPage["KBPage<br/>çŸ¥è¯†åº“è¯¦æƒ…"]
    end

    subgraph EditorComponents["ç¼–è¾‘å™¨ç»„ä»¶ç¾¤"]
        DocumentEditorModule["DocumentEditorModule<br/>æ–‡æ¡£ç¼–è¾‘æ¨¡å—"]
        SpreadsheetEditorModule["SpreadsheetEditorModule<br/>è¡¨æ ¼ç¼–è¾‘æ¨¡å—"]

        subgraph DocHeaderGroup["æ–‡æ¡£å¤´éƒ¨"]
            DocHeader["DocHeader"]
            DocToolbar["DocToolbar"]
            MenuBar["MenuBar"]
        end

        subgraph EditorCore["ç¼–è¾‘å™¨æ ¸å¿ƒ"]
            RichTextEditor["RichTextEditor<br/>(TipTap)"]
            SpreadsheetEditor["SpreadsheetEditor<br/>(FortuneSheet)"]
        end

        subgraph EditorPanels["ç¼–è¾‘å™¨é¢æ¿"]
            DocOutline["DocOutline<br/>æ–‡æ¡£å¤§çº²"]
            VersionHistorySidebar["VersionHistorySidebar<br/>ç‰ˆæœ¬å†å²"]
            CommentsSidebar["Comments<br/>è¯„è®ºé¢æ¿"]
            AISidebar["AISidebar<br/>AIåŠ©æ‰‹"]
        end
    end

    subgraph AIComponents["AI ç»„ä»¶"]
        AIQueryPanel["AIQueryPanel<br/>é—®ç­”é¢æ¿"]
        ReferencePanel["ReferencePanel<br/>å¼•ç”¨é¢æ¿"]
        ConversationTabs["ConversationTabs<br/>å¯¹è¯æ ‡ç­¾"]
        KnowledgeBaseSelector["KnowledgeBaseSelector<br/>çŸ¥è¯†åº“é€‰æ‹©å™¨"]
        MagicCommand["MagicCommand<br/>é­”æ³•å‘½ä»¤"]
    end

    subgraph SharedComponents["å…±äº«ç»„ä»¶"]
        FolderTree["FolderTree<br/>ç›®å½•æ ‘"]
        SearchModal["SearchModal<br/>æœç´¢å¼¹çª—"]
        SearchFilterPanel["SearchFilterPanel<br/>é«˜çº§ç­›é€‰"]
        SettingsModal["SettingsModal<br/>è®¾ç½®å¼¹çª—"]
        CreateItemModal["CreateItemModal<br/>æ–°å»ºå¼¹çª—"]
    end

    RootLayout --> AppSidebar
    RootLayout --> PageComponents

    DashboardPage --> AIQueryPanel
    DashboardPage --> ReferencePanel
    DashboardPage --> ConversationTabs

    EditorPage --> DocumentEditorModule
    SpreadsheetPage --> SpreadsheetEditorModule

    DocumentEditorModule --> DocHeaderGroup
    DocumentEditorModule --> RichTextEditor
    DocumentEditorModule --> EditorPanels

    SpreadsheetEditorModule --> DocHeader
    SpreadsheetEditorModule --> SpreadsheetEditor

    AppSidebar --> FolderTree
    AppSidebar --> SharedComponents
```

---

## ğŸ¤– AI æœåŠ¡æ¶æ„å›¾

```mermaid
flowchart TB
    subgraph UserInteraction["ç”¨æˆ·äº¤äº’"]
        ChatInput["ç”¨æˆ·è¾“å…¥"]
        AutoComplete["è‡ªåŠ¨è¡¥å…¨"]
        MagicCmd["é­”æ³•å‘½ä»¤"]
    end

    subgraph FrontendAI["å‰ç«¯ AI ç»„ä»¶"]
        AIQueryPanel["AIQueryPanel"]
        AISidebar["AISidebar"]
        MagicCommand["MagicCommand"]
        GhostText["GhostTextExtension<br/>å¹½çµæ–‡æœ¬"]
    end

    subgraph AIServiceLayer["AI æœåŠ¡å±‚"]
        AIService["AIService.ts<br/>ç»Ÿä¸€æœåŠ¡å…¥å£"]
        PromptRegistry["PromptRegistry.ts<br/>æç¤ºè¯ç®¡ç†"]
        StreamHandler["StreamHandler.ts<br/>æµå¼å¤„ç†"]
    end

    subgraph LocalAI["æœ¬åœ° AI å¤„ç†"]
        EmbeddingModel["embeddingModel.ts<br/>Xenova/all-MiniLM"]
        EmbeddingPool["embeddingPool.ts<br/>åµŒå…¥æ± "]
        SemanticCache["semanticCache.ts<br/>è¯­ä¹‰ç¼“å­˜"]
        KnowledgeGraph["knowledgeGraph.ts<br/>çŸ¥è¯†å›¾è°±"]
        Reranker["reranker.ts<br/>é‡æ’åº"]
        IntentRouter["intentRouter.ts<br/>æ„å›¾è·¯ç”±"]
    end

    subgraph APIRoutes["API è·¯ç”±"]
        ChatAPI["/api/chat"]
        CompletionAPI["/api/completion"]
        EmbeddingsAPI["/api/embeddings"]
        SearchAPI["/api/search"]
    end

    subgraph ExternalLLM["å¤–éƒ¨ LLM"]
        DeepSeek["DeepSeek API<br/>(é»˜è®¤)"]
        Gemini["Google Gemini"]
    end

    subgraph VectorDB["å‘é‡æ•°æ®åº“"]
        PGVector["Supabase pgvector<br/>è¯­ä¹‰æœç´¢"]
    end

    ChatInput --> AIQueryPanel
    AutoComplete --> GhostText
    MagicCmd --> MagicCommand

    FrontendAI --> AIServiceLayer
    AIServiceLayer --> APIRoutes
    APIRoutes --> ExternalLLM
    
    FrontendAI --> LocalAI
    LocalAI --> PGVector
    SearchAPI --> PGVector
    EmbeddingsAPI --> EmbeddingModel
```

---

## ğŸ“¡ å®æ—¶åä½œæ¶æ„å›¾

```mermaid
sequenceDiagram
    participant U1 as ç”¨æˆ· A
    participant U2 as ç”¨æˆ· B
    participant FE1 as å‰ç«¯ A
    participant FE2 as å‰ç«¯ B
    participant WS as WebSocket Server
    participant YJS as Yjs CRDT
    participant DB as Supabase

    U1->>FE1: ç¼–è¾‘æ–‡æ¡£
    FE1->>YJS: æœ¬åœ°æ›´æ–° Y.Doc
    YJS->>WS: åŒæ­¥å¢é‡æ•°æ®
    WS->>YJS: å¹¿æ’­åˆ°å…¶ä»–å®¢æˆ·ç«¯
    YJS->>FE2: åˆå¹¶è¿œç¨‹æ›´æ–°
    FE2->>U2: å®æ—¶æ˜¾ç¤ºå˜æ›´

    Note over FE1,FE2: åä½œå…‰æ ‡åŒæ­¥
    FE1->>WS: awareness.setLocalState
    WS->>FE2: å¹¿æ’­å…‰æ ‡ä½ç½®

    Note over FE1,DB: å®šæœŸæŒä¹…åŒ–
    FE1->>DB: è‡ªåŠ¨ä¿å­˜ (5s)
    DB-->>FE1: ç¡®è®¤ä¿å­˜
```

---

## ğŸ—ï¸ æœåŠ¡å±‚èŒè´£åˆ’åˆ†

| æœåŠ¡å | èŒè´£ | ç®¡ç†çš„æ•°æ®è¡¨ |
|--------|------|-------------|
| `teamService.ts` | å›¢é˜Ÿ CRUD + æˆå‘˜ç®¡ç† | `teams`, `team_members` |
| `kbService.ts` | çŸ¥è¯†åº“ + æ–‡ä»¶å¤¹ç®¡ç† | `knowledge_bases`, `kb_folders` |
| `documentService.ts` (StorageContext) | æ–‡æ¡£ CRUD + ç‰ˆæœ¬/è¯„è®º | `documents`, `versions`, `comments` |
| `spreadsheetService.ts` | è¡¨æ ¼ CRUD + å‘é‡åŒ– | `spreadsheets`, `spreadsheet_embeddings` |
| `commentService.ts` | è¯„è®ºç³»ç»Ÿ | `comments` |
| `versionService.ts` | ç‰ˆæœ¬å†å² | `versions` |
| `departmentService.ts` | éƒ¨é—¨ç®¡ç† | `departments`, `department_members` |

---

## ğŸ§¬ ç¼–è¾‘å™¨æ‰©å±•æ¶æ„

```mermaid
mindmap
  root((RichTextEditor))
    TipTap StarterKit
      Paragraph
      Heading
      BulletList
      OrderedList
      Blockquote
      CodeBlock
      HardBreak
    æ ¼å¼æ‰©å±•
      FontFamily
      FontSize
      Color
      Highlight
      TextAlign
      TextStyle
    è¡¨æ ¼æ‰©å±•
      Table
      TableRow
      TableCell
      TableHeader
      TableContextMenu
    åä½œæ‰©å±•
      Collaboration
      CollaborationCursor
      CommentMark
    åª’ä½“æ‰©å±•
      ResizableImage
      Link
      MermaidExtension
      FlowchartExtension
    AI æ‰©å±•
      GhostTextExtension
      SuggestionMark
      MagicCommand
    é«˜çº§æ‰©å±•
      Indent
      TaskList
      TaskItem
      SearchReplaceExtension
      ModuleExtensions
```

---

## ğŸ”’ å®‰å…¨æ¶æ„ (RLS)

```mermaid
flowchart LR
    subgraph Client["å®¢æˆ·ç«¯è¯·æ±‚"]
        User["ç”¨æˆ·"]
    end

    subgraph Auth["è®¤è¯å±‚"]
        JWT["JWT Token"]
        SupaAuth["Supabase Auth"]
    end

    subgraph RLS["è¡Œçº§å®‰å…¨ç­–ç•¥"]
        PolicyDocs["documents:<br/>auth.uid() = user_id"]
        PolicyFolders["folders:<br/>auth.uid() = user_id"]
        PolicyTeams["teams:<br/>visibility = 'public'<br/>OR membership"]
        PolicyKB["knowledge_bases:<br/>team membership"]
    end

    subgraph Data["æ•°æ®å±‚"]
        DB[(PostgreSQL)]
    end

    User --> JWT
    JWT --> SupaAuth
    SupaAuth --> RLS
    RLS --> DB
    
    style RLS fill:#f9f,stroke:#333
```

---

## ğŸ“± é¡µé¢è·¯ç”±æ¶æ„

| è·¯ç”± | ç»„ä»¶ | åŠŸèƒ½æè¿° |
|------|------|----------|
| `/` | `Home` | é‡å®šå‘åˆ° `/login` æˆ– `/dashboard` |
| `/login` | `LoginPage` | ç”¨æˆ·ç™»å½•/æ³¨å†Œ |
| `/dashboard` | `Dashboard` | é¦–é¡µï¼Œå±•ç¤º"é—® AI"ç•Œé¢ |
| `/editor/[id]` | `EditorPage` | æ–‡æ¡£ç¼–è¾‘å™¨ |
| `/spreadsheet/[id]` | `SpreadsheetPage` | è¡¨æ ¼ç¼–è¾‘å™¨ |
| `/teams` | `TeamsPage` | å›¢é˜Ÿåˆ—è¡¨ |
| `/teams/[teamId]` | `TeamDetailPage` | å›¢é˜Ÿè¯¦æƒ… |
| `/teams/[teamId]/kb/[kbId]` | `KBPage` | çŸ¥è¯†åº“è¯¦æƒ… |

---

## ğŸ¨ æŠ€æœ¯æ ˆæ€»è§ˆ

```mermaid
pie title æŠ€æœ¯æ ˆæ„æˆ
    "Next.js 16 (React 19)" : 35
    "TipTap Editor" : 20
    "Supabase (Auth + DB)" : 25
    "AI æœåŠ¡ (DeepSeek/Gemini)" : 15
    "Yjs åä½œ" : 5
```

---

## ğŸ“Œ æ ¸å¿ƒç‰¹æ€§æ€»ç»“

### âœ… å·²å®ç°

- ğŸ” **ç”¨æˆ·è®¤è¯**: Supabase Auth (é‚®ç®±ç™»å½•)
- ğŸ“ **å¯Œæ–‡æœ¬ç¼–è¾‘**: TipTap + 20+ æ‰©å±•
- ğŸ“Š **è¡¨æ ¼ç¼–è¾‘**: FortuneSheet
- ğŸ“ **ç›®å½•ç®¡ç†**: æ ‘å½¢ç»“æ„ + æ‹–æ‹½
- ğŸ¤– **AI è¾…åŠ©**: è‡ªåŠ¨è¡¥å…¨ã€é—®ç­”ã€é­”æ³•å‘½ä»¤
- ğŸ” **è¯­ä¹‰æœç´¢**: æœ¬åœ°å‘é‡åŒ– + pgvector
- ğŸ‘¥ **å›¢é˜Ÿåä½œ**: å›¢é˜Ÿ/çŸ¥è¯†åº“/æƒé™ç®¡ç†
- ğŸ”„ **å®æ—¶åä½œ**: Yjs + WebSocket
- ğŸ“œ **ç‰ˆæœ¬å†å²**: è‡ªåŠ¨/æ‰‹åŠ¨ä¿å­˜ + å¯¹æ¯”
- ğŸ’¬ **è¯„è®ºç³»ç»Ÿ**: æ–‡æ¡£å†…è¯„è®º + å›å¤

### ğŸš§ æ‰©å±•æ–¹å‘

- ğŸ“± ç§»åŠ¨ç«¯é€‚é…
- ğŸ”— ç¬¬ä¸‰æ–¹é›†æˆ (Slack, é£ä¹¦)
- ğŸ“ˆ æ•°æ®åˆ†æä»ªè¡¨ç›˜
- ğŸŒ å¤šè¯­è¨€æ”¯æŒ

---

> ğŸ›¸ *æ¶æ„å›¾ç”± Antigravity AI è‡ªåŠ¨ç”Ÿæˆ*
